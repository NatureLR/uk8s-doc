## Kubernetes 1.30版本重要变更说明

#### PVC和Container的API使用相同的ResourceRequirements结构体来定义资源requests和limits

这导致当Container的resources结构发生变化时，例如新增了claims字段，会导致PVC的API也随之改变。因此，PVC改用独立的VolumeResourceRequirements结构体，其中仅包含requests和limits，不包含claims。更多信息，请参见[Volume resource requirements](https://github.com/kubernetes/kubernetes/pull/118653)。

#### CronJob不再支持CRON_TZ或者TZ

CronJob不支持在.spec.schedule配置CRON_TZ或者TZ，使用.spec.timeZone字段代替（该字段自v1.25可用）。更多信息，[请参见CronJob的限制](https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/#cron-job-limitations)。

#### PodAffinity添加matchLabelKeys字段

PodAffinity和PodAntiAffinity新增支持matchLabelKeys和mismatchLabelKeys，以解决调度器在Deployment滚动更新期间无法区分新老Pod，继而导致调度结果不符合亲和性和反亲和性预期的问题。配置PodAffinity的matchLabelKeys时，Deployment会为ReplicaSet添加pod-template-hash标签，让Deployment的每个Pod都带有相应的哈希字符串，来告知调度器仅对带有相同pod-template-hash值的Pod进行评估，便于区分同一批次更新的Pod。更多信息，请参见[KEP-3633](https://github.com/kubernetes/enhancements/tree/master/keps/sig-scheduling/3633-matchlabelkeys-to-podaffinity#user-stories-optional)。

#### Pod新增PodReadyToStartContainers

PodReadyToStartContainers特性进入Beta，默认启用。此特性表示Pod的沙盒（Sandbox）环境已经成功创建（容器运行时环境已就绪），且网络配置已完成，便于kubelet了解Pod状态。更多信息，请参见[Pod conditions](https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-conditions)。

#### CRD支持类型检查

除核心Kubernetes API资源外，ValidatingAdmissionPolicy类型检查新增支持CRD和API Extension类型，有助于确保策略的可靠性和集群配置的正确性。更多信息，请参见[type-checking](https://kubernetes.io/docs/reference/access-authn-authz/validating-admission-policy/#type-checking)。

#### kubectl移除--prune-whitelist

建议使用--prune-allowlist代替。更多信息，[请参见--prune](https://kubernetes.io/docs/tasks/manage-kubernetes-objects/declarative-config/#alternative-kubectl-apply-f-directory-prune)。

### api弃用

flowcontrol.apiserver.k8s.io/v1beta2 API版本的FlowSchema和PriorityLevelConfiguration在v1.29被废弃。建议使用flowcontrol.apiserver.k8s.io/v1 API版本（自v1.29开始可用），或 flowcontrol.apiserver.k8s.io/v1beta3 API版本（自v1.26起可用）。

- flowcontrol.apiserver.k8s.io/v1中的显著变更包括：

PriorityLevelConfiguration的spec.limited.assuredConcurrencyShares字段已被重命名为 spec.limited.nominalConcurrencyShares，仅在未指定时默认为30，并且显式值0不会更改为30。

- flowcontrol.apiserver.k8s.io/v1beta3中的显著变更包括：

PriorityLevelConfiguration的spec.limited.assuredConcurrencyShares字段已被更名为 spec.limited.nominalConcurrencyShares。

## uk8s 1.30 变更说明

- kube-apiserver loopback证书过期时间修改为10年以解决每年[重启kube-apiserver的问题](/uk8s/troubleshooting/cluster_summary)。
- 控制组件kube-controller-manager，kube-scheduler，scheduler-extender权限更加精细化。
- Centos7.6和Ubuntu20.04已经进入EOL，1.30不在支持此镜像。
- 镜像中默认注入了容器产品的ssh key公钥，添加节点或者新建集群时不再代码注入，使用自定义镜像的请注意，如果没有注入ssh key公钥，可能导致添加节点或者创建集群失败。

### 参考链接

更多完整的变更记录请参阅 [CHANGELOG 1.29](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.29.md)，[CHANGELOG 1.30](https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.30.md)
