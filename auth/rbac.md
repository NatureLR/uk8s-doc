# UK8S RBAC 授权管理

> ⚠️ 如果没有开启授权管理，子账号将不会受到Kubernetes RBAC授权管理，并且可以直接看到集群的管理凭证。

> ⚠️ 针对注销、冻结或封号的子账号，UK8S侧并不能自动撤销该账号的授权，此时凭证将会仍然可用。为了安全起见，需要手动在授权管理进行撤销。

> ⚠️ 目前不支持对授信账号进行授权管理。

> ⚠️ 如果是历史集群，管理凭证可能已经被子账号拿到并保存。为了安全建议立即开启授权管理并评估管理凭证是否已经泄漏。

授权管理操作只能由主账号进行，并且只能对该账号的子账号进行授权。关于如何邀请子账号，请参考：[子用户](https://docs.ucloud.cn/uproject/user)。

在集群的`授权管理`页面，可以进行集群的RBAC授权管理操作。如果您的集群是历史集群，可能需要手动开启授权管理功能。您可以在授权管理页面看到当前已经创建的授权：

![auth](/images/auth/rbac_list.png)

## 授权说明

> 在Kubernetes中，资源一般分为两类：
>
> **命名空间资源**：一般包括工作负载、存储配置、集群伸缩等。例如Deployment、Pod、StatefulSet、ConfigMap等。
>
> **集群资源**：一般包括节点、存储类、命名空间等。例如Node、StorageClass、Namespace、CRD等。

- 如果选了命名空间（包括全选），将会在Kubernetes中进行`RoleBindings`创建。此时子账号将无法操作集群资源。
- 如果选择了`所有命令空间`，将会在Kubernetes中进行`ClusterRoleBindings`创建。
  - 如果角色是`管理员`，子账号将可以操作集群所有资源。
  - 如果角色是`开发者`，子账号可以操作命名空间资源但是无法操作集群资源。

然后您需要选择给子账号授予的`角色&权限`。在Kubernetes中，它们实际上对应的是集群中的`ClusterRole`（暂不支持`Role`）。

我们预置了一些角色，来方便您的配置：

| 角色       | 权限                                                         |
| ---------- | ------------------------------------------------------------ |
| 管理员     | 所有命名空间资源和集群资源的读写权限                         |
| 只读管理员 | 所有命名空间资源和集群资源的只读权限                         |
| 开发者     | 所有或部分命名空间资源的读写权限，**无法读写Secrets敏感资源** |
| 只读开发者 | 所有或部分命名空间资源的只读权限，**无法读取Secrtes敏感资源** |
| 自定义     | 当上述权限无法满足要求时，可以通过指定ClusterRole来自定义权限<br />您需要先创建ClusterRole，详见：[ClusterRole](https://kubernetes.io/zh-cn/docs/reference/kubernetes-api/authorization-resources/cluster-role-v1/)<br />**注意：请谨慎授予`cluster-admin`权限，它类似超级管理员，拥有对所有资源的读写权限。** |

子账号在控制台的行为除了受到IAM授权的限制，也会受到RBAC授权的限制。例如，如果子账号只被授予了`default`这个命名空间的权限，那么他在控制台就无法查看别的命名空间的资源了。如果子账号是只读权限，进行修改操作也会报错。

子账号通过集群列表页进入`kubectl`控制台，也将会使用子账号自己的凭证。

> 注意：子账号在集群列表页进入`kubectl`控制台，会在您的集群下创建一个Pod用于访问集群，该Pod会在子账号退出kubectl页面后被销毁（每个控制台都会启动一个Pod）。
>
> 为了防止滥用导致Pod过多，子账号的kubectl Pod最多只能运行2小时，也就是说子账号使用kubectl有时长限制，超过时间需要重新打开。这个限制对主账号不生效。
>
> **如果您不希望子账号使用`kubectl`功能，可以在[UK8S IAM 授权管理](/uk8s/auth/IAM)中禁用`GetUK8STerminalToken`这个权限。**

## 创建授权

![auth](/images/auth/rbac_create.png)

在新增授权页面，首先需要选择`授权对象`，这里会列出当前账号的所有子账号进行筛选，注意同一个子账号在同一集群中只能被授权一次，如果您需要更改账号的权限，请使用`修改权限`功能。

在选择角色之前，需要先选择`授权命名空间`，它将决定子账号可以操作哪些命名空间的资源。

在创建授权之后，子账号就能通过UK8S控制台或独立的凭证来访问UK8S中的资源了。子账号登录控制台可以看到自己的独立凭证。这个凭证不同于集群的管理凭证，是为当前子账号单独颁发的，并且主账号随时可以对这个凭证进行撤销或刷新。

## 刷新凭证

每个凭证都有自己的有效时间。当凭证过期时，子账号将无法再通过凭证访问集群，这时候主账号需要对凭证进行刷新操作：

![auth](/images/auth/rbac_refresh.png)

在凭证快要过期时，我们会提示您尽快刷新凭证。如果您不希望频繁刷新凭证，请选择尽量长的凭证过期时间。

## 修改权限

已经授权的用户是可以对它的命名空间或权限进行修改的：

![auth](/images/auth/rbac_update.png)

修改之后新的权限会立即生效（会重新创建RoleBinding或ClusterRoleBinding），并且凭证不会发生改变。

## 撤销授权

您可以随时撤销某个子账号的授权：

![auth](/images/auth/rbac_delete.png)

在授权撤销之后，子账号将无法继续访问或操作UK8S中的资源了。他的凭证也将会无法使用。

## 子账号创建的集群

如果集群是通过子账号创建的，我们会默认给子账号创建一个`cluster-admin`权限。但是该子账号仍然无法给其他账号进行RBAC授权。

此时作为创建者的子账号仍然无法拿到集群的管理凭证，只能看到自己的独立凭证。主账号也仍然可以对该子账号进行权限更改、撤销授权等操作。
